<!DOCTYPE html>
<html lang="id">
<head>
  <meta name="google" content="notranslate">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Riwayat Sensor - Monitoring Tanah</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #a8e063, #56ab2f);
      color: white;
      display: flex;
    }
    .sidebar {
      width: 250px;
      padding: 20px;
      background: linear-gradient(to bottom, #2e7d32, #ffffff);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      transform: translateX(0);
      transition: transform 0.3s ease-in-out;
      z-index: 1001;
    }
    .sidebar h2 { margin-top: 40px; font-size: 22px; margin-bottom: 30px; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li { margin: 15px 0; }
    .sidebar ul li a { color: white; text-decoration: none; }
    .main {
      flex: 1;
      padding: 30px;
      margin-left: 250px;
    }
    .topbar {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: right;
    }
    .history-container {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
    }
    .search-box input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      outline: none;
      color: #333;
    }
    .controls-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .export-buttons button, .data-limit-selector select {
      padding: 10px 15px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #fff;
      color: #4CAF50;
      font-weight: bold;
    }
    .export-buttons button:hover {
      background-color: #e0e0e0;
    }
    table {
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      color: black;
      transition: opacity 0.3s ease-in-out;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #4CAF50;
      color: white;
      white-space: normal;
      word-wrap: break-word;
    }
    td {
      white-space: nowrap;
    }

    th, td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 2px solid #bbb;
  /* Tambahkan baris ini untuk garis vertikal */
  border-right: 2px solid #bbb;
}

/* (Opsional) Hapus garis di kolom terakhir agar rapi */
th:last-child, 
td:last-child {
  border-right: none;
}

    .hamburger, .overlay { display: none; }
    
    @media (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar { transform: translateX(-100%); }
      .sidebar.active { transform: translateX(0); }
      .hamburger { display: block; font-size: 24px; cursor: pointer; padding: 10px; color: white; background: none; border: none; z-index: 1002; position: absolute; top: 15px; left: 15px;}
      .main { padding: 20px; margin: 0; margin-top: 50px; }
      .topbar { text-align: center; }
      .overlay.active { display: block; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.4); z-index: 1000; }
    }
  </style>
</head>
<body>
  <button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

  <div class="sidebar" id="sidebar">
    <h2>IoT Monitoring</h2>
    <ul>
      <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
      <li><a href="logout.html"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      <li><a href="panduan.html"><i class="fas fa-book"></i> Panduan Sistem</a></li>
    </ul>
    <div style="margin-top: 40px; background-color: #1b5e20; padding: 12px; border-radius: 8px; text-align: center; font-size: 12px; color: #f0f0f0; line-height: 1.5;">
      <strong>Developer</strong><br>
      Ahmad Farzi Anwar<br>
      <a href="mailto:ahmadfarzianwar4@gmail.com" style="color: #a5d6a7;">ahmadfarzianwar4@gmail.com</a><br>
      <a href="https://instagram.com/_ahmadfarzi29" target="_blank" style="color: #a5d6a7;">_ahmadfarzi29</a>
    </div>
    <div style="margin-top: 20px; background-color: #ffffff; padding: 10px; border-radius: 10px; text-align: center; font-size: 13px; color: #2e7d32; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
      <i class="fas fa-circle" style="color: #4caf50;"></i> <span style="margin-left: 6px;">Sistem Aktif</span>
    </div>
  </div>

  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <div class="main">
    <div class="topbar">Riwayat lengkap data sensor suhu & kelembaban</div>
    <div class="history-container">
      <div class="controls-container">
        <div class="export-buttons">
          <button onclick="exportToExcel()">Export ke Excel</button>
          <button onclick="exportToPDF()">Export ke PDF</button>
        </div>
        <div class="data-limit-selector">
          <label for="dataLimit">Jumlah Data:</label>
          <select id="dataLimit">
            <option value="10">10 Data Terakhir</option>
            <option value="20" selected>20 Data Terakhir</option>
            <option value="50">50 Data Terakhir</option>
          </select>
        </div>
      </div>
      
      <div class="overflow-x-auto bg-white rounded-lg shadow-md">
        <table id="historyTable" class="min-w-full">
          <thead>
            <tr>
              <th class="w-[30%]">Tanggal</th>
              <th class="w-[30%] text-center">Waktu</th>
              <th class="w-[20%] text-center">Suhu (°C)</th>
              <th class="w-[25%] text-center">Kelembaban (%)</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>

      <div class="text-center mt-4">
        <button id="scrollTopBtn" onclick="scrollToTop()" style="display:none; padding: 10px 20px; border: none; border-radius: 6px; background-color: #fff; color: #4CAF50; font-weight: bold;">
          Kembali ke Atas
        </button>
      </div>      
    </div>
    <footer style="text-align: center; padding: 20px; color: rgb(17, 16, 16); font-size: 14px;">
      © 2025 Ahmad Farzi Anwar. All rights reserved.
    </footer>
  </div>

 <script>
  const firebaseConfig = {
    apiKey: "AIzaSyD9vzTunp4P3qZynga-6kWf5ChjnBcgInU",
    authDomain: "sistem-monitoring-esp32-1f8a3.firebaseapp.com",
    databaseURL:
      "https://sistem-monitoring-esp32-1f8a3-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sistem-monitoring-esp32-1f8a3",
    storageBucket: "sistem-monitoring-esp32-1f8a3.firebasestorage.app",
    messagingSenderId: "389502240374",
    appId: "1:389502240374:web:369c54e175ce48459c8157",
    measurementId: "G-1LK2BRC4PG",
  };
  firebase.initializeApp(firebaseConfig);

  // [PERBAIKAN] Mengembalikan isi fungsi yang sebelumnya hilang
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    sidebar.classList.toggle("active");
    overlay.classList.toggle("active");
  }

  function exportToExcel() {
    const table = document.getElementById("historyTable");
    const wb = XLSX.utils.table_to_book(table, { sheet: "Riwayat Sensor" });
    XLSX.writeFile(wb, "riwayat_sensor.xlsx");
  }

  function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Riwayat Sensor Suhu & Kelembaban", 14, 15);
    doc.autoTable({ html: "#historyTable", startY: 20 });
    doc.save("riwayat_sensor.pdf");
  }
  
  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // Logika untuk menampilkan/menyembunyikan tombol "Kembali ke Atas"
  window.onscroll = function() {
    scrollFunction();
  };

  function scrollFunction() {
    let mybutton = document.getElementById("scrollTopBtn");
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
      mybutton.style.display = "block";
    } else {
      mybutton.style.display = "none";
    }
  }

  const db = firebase.database();
  
  function fetchAndRenderTable(limit) {
    const table = document.getElementById("historyTable");
    const tbody = table.querySelector("tbody");
    table.style.opacity = '0.5';

    const historyRef = db.ref("sensorHistory").limitToLast(limit);
    historyRef.once("value", (snapshot) => {
      tbody.innerHTML = ''; 
      if (snapshot.exists()) {
        const data = snapshot.val();
        const keys = Object.keys(data).sort().reverse();

        keys.forEach((key) => {
  const item = data[key];

  // Parsing tanggal dan waktu dari key "250730-185720"
  const [tanggalStr, waktuStr] = key.split("-");

  const tahun = "20" + tanggalStr.substring(0, 2);
  const bulan = tanggalStr.substring(2, 4);
  const tanggal = tanggalStr.substring(4, 6);
  const jam = waktuStr.substring(0, 2);
  const menit = waktuStr.substring(2, 4);
  const detik = waktuStr.substring(4, 6);

  const tanggalFormatted = `${tanggal}/${bulan}/${tahun}`;
  const waktuFormatted = `${jam}:${menit}:${detik}`;

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${tanggalFormatted}</td>
    <td class="text-center">${waktuFormatted}</td>
    <td class="text-center">${item.suhu?.toFixed(1) ?? "-"}</td>
    <td class="text-center">${item.kelembaban?.toFixed(1) ?? "-"}</td>
  `;
  tbody.appendChild(row);
});

      } else {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Tidak ada data riwayat.</td></tr>';
      }
      table.style.opacity = '1';
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const initialLimit = parseInt(document.getElementById("dataLimit").value);
    fetchAndRenderTable(initialLimit);
    
    document.getElementById("dataLimit").addEventListener("change", function () {
      const newLimit = parseInt(this.value);
      fetchAndRenderTable(newLimit);
    });
  });

 </script>
</body>
</html>